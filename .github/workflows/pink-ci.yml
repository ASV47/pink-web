name: Fast Deploy to EB

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-central-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci
      - run: npm run build

      - name: Find index.html folder
        id: outdir
        shell: bash
        run: |
          set -e
          INDEX=$( ( [ -d dist ] && find dist -type f -name index.html | head -n 1 ) || true )
          [ -z "$INDEX" ] && INDEX=$( ( [ -d build ] && find build -type f -name index.html | head -n 1 ) || true )
          [ -z "$INDEX" ] && INDEX=$( ( [ -d out ] && find out -type f -name index.html | head -n 1 ) || true )
          [ -n "$INDEX" ] || (echo "❌ index.html not found" && exit 1)
          echo "dir=$(dirname "$INDEX")" >> $GITHUB_OUTPUT

      - name: Build EB bundle
        shell: bash
        run: |
          set -e
          rm -rf deploy app.zip
          mkdir -p deploy/dist
          cp -R "${{ steps.outdir.outputs.dir }}/." deploy/dist/
          test -f deploy/dist/index.html || (echo "❌ missing deploy/dist/index.html" && exit 1)
          cat > deploy/server.js <<'JS'
          const express=require("express"); const path=require("path");
          const app=express(); const port=process.env.PORT||8080;
          const dist=path.join(__dirname,"dist");
          app.get("/health",(req,res)=>res.send("OK"));
          app.use(express.static(dist));
          app.get("*",(req,res)=>res.sendFile(path.join(dist,"index.html")));
          app.listen(port,"0.0.0.0",()=>console.log("up",port));
          JS
          cat > deploy/package.json <<'JSON'
          { "name":"fe","private":true,"version":"1.0.0","main":"server.js",
            "engines":{"node":"20.x"},
            "scripts":{"start":"node server.js"},
            "dependencies":{"express":"^4.19.2"} }
          JSON
          echo "web: node server.js" > deploy/Procfile
          (cd deploy && zip -r ../app.zip .)

      - name: AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Deploy (no wait)
        shell: bash
        run: |
          set -e
          VERSION="${GITHUB_SHA}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          EB_BUCKET="elasticbeanstalk-${AWS_REGION}-${ACCOUNT_ID}"
          KEY="releases/${VERSION}.zip"

          # create EB bucket if missing
          aws s3api head-bucket --bucket "$EB_BUCKET" 2>/dev/null || \
            aws s3api create-bucket --bucket "$EB_BUCKET" --region "$AWS_REGION" --create-bucket-configuration LocationConstraint="$AWS_REGION"

          aws s3 cp app.zip "s3://${EB_BUCKET}/${KEY}"

          aws elasticbeanstalk create-application-version \
            --application-name "${{ secrets.EB_APP_NAME }}" \
            --version-label "${VERSION}" \
            --source-bundle S3Bucket="${EB_BUCKET}",S3Key="${KEY}" || true

          aws elasticbeanstalk update-environment \
            --environment-name "${{ secrets.EB_ENV_NAME }}" \
            --version-label "${VERSION}" || true

          # restart to force pick up
          aws elasticbeanstalk restart-app-server \
            --environment-name "${{ secrets.EB_ENV_NAME }}" || true

          echo "✅ Open: http://${{ secrets.EB_ENV_NAME }}.eu-central-1.elasticbeanstalk.com/"
