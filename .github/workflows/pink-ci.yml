name: Deploy Frontend to Elastic Beanstalk (HiPink)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: hipink-frontend-eb
  cancel-in-progress: true

env:
  AWS_REGION: eu-central-1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required secrets exist
        shell: bash
        run: |
          set -e
          [ -n "${{ secrets.AWS_ROLE_ARN }}" ] || (echo "‚ùå Missing secret: AWS_ROLE_ARN" && exit 1)
          [ -n "${{ secrets.DEPLOY_BUCKET }}" ] || (echo "‚ùå Missing secret: DEPLOY_BUCKET" && exit 1)
          [ -n "${{ secrets.EB_APP_NAME }}" ] || (echo "‚ùå Missing secret: EB_APP_NAME" && exit 1)
          [ -n "${{ secrets.EB_ENV_NAME }}" ] || (echo "‚ùå Missing secret: EB_ENV_NAME" && exit 1)
          echo "‚úÖ Secrets are present"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install + Build
        shell: bash
        run: |
          set -e
          npm ci
          npm run build

      # ‚úÖ NEW: find the real folder that contains index.html (supports Angular SSR dist/<app>/browser)
      - name: Locate index.html output folder
        id: outdir
        shell: bash
        run: |
          set -e

          echo "üîé Searching for index.html in dist/build/out ..."
          INDEX_PATH=""

          if [ -d "dist" ]; then
            INDEX_PATH=$(find dist -type f -name "index.html" | head -n 1 || true)
          fi

          if [ -z "$INDEX_PATH" ] && [ -d "build" ]; then
            INDEX_PATH=$(find build -type f -name "index.html" | head -n 1 || true)
          fi

          if [ -z "$INDEX_PATH" ] && [ -d "out" ]; then
            INDEX_PATH=$(find out -type f -name "index.html" | head -n 1 || true)
          fi

          if [ -z "$INDEX_PATH" ]; then
            echo "‚ùå index.html not found in dist/build/out."
            echo "=== DEBUG LIST (top level) ==="
            ls -la
            echo "=== DEBUG dist (if exists) ==="
            [ -d dist ] && find dist -maxdepth 3 -type f | head -n 80 || true
            echo "=== DEBUG build (if exists) ==="
            [ -d build ] && find build -maxdepth 3 -type f | head -n 80 || true
            echo "=== DEBUG out (if exists) ==="
            [ -d out ] && find out -maxdepth 3 -type f | head -n 80 || true
            exit 1
          fi

          OUT_DIR=$(dirname "$INDEX_PATH")
          echo "‚úÖ Found index.html at: $INDEX_PATH"
          echo "‚úÖ Using output dir: $OUT_DIR"
          echo "dir=$OUT_DIR" >> $GITHUB_OUTPUT

      - name: Prepare EB bundle (Express serves SPA)
        shell: bash
        run: |
          set -e
          rm -rf deploy app.zip
          mkdir -p deploy/dist

          # Copy built files (folder that contains index.html) into deploy/dist
          cp -R "${{ steps.outdir.outputs.dir }}/." deploy/dist/

          # Ensure index.html exists where server expects it
          test -f deploy/dist/index.html || (echo "‚ùå After copy, deploy/dist/index.html still missing" && ls -la deploy/dist && exit 1)

          # Node server to serve SPA + fallback to index.html
          cat > deploy/server.js <<'JS'
          const express = require('express');
          const path = require('path');

          const app = express();
          const port = process.env.PORT || 8080;
          const distDir = path.join(__dirname, 'dist');

          app.get('/health', (req, res) => res.status(200).send('OK'));
          app.use(express.static(distDir));

          // SPA fallback
          app.get('*', (req, res) => {
            res.sendFile(path.join(distDir, 'index.html'));
          });

          app.listen(port, '0.0.0.0', () => {
            console.log(`Frontend running on http://0.0.0.0:${port}`);
          });
          JS

          # Minimal package.json for EB runtime
          cat > deploy/package.json <<'JSON'
          {
            "name": "hipink-frontend-eb",
            "private": true,
            "version": "1.0.0",
            "main": "server.js",
            "engines": { "node": "20.x" },
            "scripts": { "start": "node server.js" },
            "dependencies": { "express": "^4.19.2" }
          }
          JSON

          # ‚úÖ IMPORTANT: force EB to run our server
          echo "web: node server.js" > deploy/Procfile

          (cd deploy && zip -r ../app.zip .)

          echo "‚úÖ ZIP content preview:"
          unzip -l app.zip | head -n 60

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Upload + Deploy to Elastic Beanstalk
        shell: bash
        run: |
          set -e

          VERSION="${GITHUB_SHA}"
          KEY="releases/${VERSION}.zip"

          aws s3 cp app.zip "s3://${{ secrets.DEPLOY_BUCKET }}/${KEY}"

          aws elasticbeanstalk create-application-version \
            --application-name "${{ secrets.EB_APP_NAME }}" \
            --version-label "${VERSION}" \
            --source-bundle S3Bucket="${{ secrets.DEPLOY_BUCKET }}",S3Key="${KEY}"

          aws elasticbeanstalk update-environment \
            --environment-name "${{ secrets.EB_ENV_NAME }}" \
            --version-label "${VERSION}"
