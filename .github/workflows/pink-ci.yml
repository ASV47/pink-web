name: Deploy Frontend to Elastic Beanstalk (HiPink)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: hipink-frontend-eb
  cancel-in-progress: true

env:
  AWS_REGION: eu-central-1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required secrets exist
        shell: bash
        run: |
          set -e
          [ -n "${{ secrets.AWS_ROLE_ARN }}" ] || (echo "❌ Missing secret: AWS_ROLE_ARN" && exit 1)
          [ -n "${{ secrets.DEPLOY_BUCKET }}" ] || (echo "❌ Missing secret: DEPLOY_BUCKET" && exit 1)
          [ -n "${{ secrets.EB_APP_NAME }}" ] || (echo "❌ Missing secret: EB_APP_NAME" && exit 1)
          [ -n "${{ secrets.EB_ENV_NAME }}" ] || (echo "❌ Missing secret: EB_ENV_NAME" && exit 1)
          echo "✅ Secrets are present"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install + Build
        shell: bash
        run: |
          set -e
          npm ci
          npm run build

      - name: Locate index.html output folder
        id: outdir
        shell: bash
        run: |
          set -e
          INDEX_PATH=""

          if [ -d "dist" ]; then
            INDEX_PATH=$(find dist -type f -name "index.html" | head -n 1 || true)
          fi
          if [ -z "$INDEX_PATH" ] && [ -d "build" ]; then
            INDEX_PATH=$(find build -type f -name "index.html" | head -n 1 || true)
          fi
          if [ -z "$INDEX_PATH" ] && [ -d "out" ]; then
            INDEX_PATH=$(find out -type f -name "index.html" | head -n 1 || true)
          fi

          if [ -z "$INDEX_PATH" ]; then
            echo "❌ index.html not found in dist/build/out."
            ls -la
            [ -d dist ] && find dist -maxdepth 4 -type f | head -n 120 || true
            [ -d build ] && find build -maxdepth 4 -type f | head -n 120 || true
            [ -d out ] && find out -maxdepth 4 -type f | head -n 120 || true
            exit 1
          fi

          OUT_DIR=$(dirname "$INDEX_PATH")
          echo "✅ Found index.html at: $INDEX_PATH"
          echo "dir=$OUT_DIR" >> $GITHUB_OUTPUT

      - name: Prepare EB bundle (Express serves SPA)
        shell: bash
        run: |
          set -e
          rm -rf deploy app.zip
          mkdir -p deploy/dist

          cp -R "${{ steps.outdir.outputs.dir }}/." deploy/dist/
          test -f deploy/dist/index.html || (echo "❌ deploy/dist/index.html missing after copy" && ls -la deploy/dist && exit 1)

          cat > deploy/server.js <<'JS'
          const express = require('express');
          const path = require('path');

          const app = express();
          const port = process.env.PORT || 8080;
          const distDir = path.join(__dirname, 'dist');

          app.get('/health', (req, res) => res.status(200).send('OK'));
          app.use(express.static(distDir));

          app.get('*', (req, res) => {
            res.sendFile(path.join(distDir, 'index.html'));
          });

          app.listen(port, '0.0.0.0', () => {
            console.log(`Frontend running on http://0.0.0.0:${port}`);
          });
          JS

          cat > deploy/package.json <<'JSON'
          {
            "name": "hipink-frontend-eb",
            "private": true,
            "version": "1.0.0",
            "main": "server.js",
            "engines": { "node": "20.x" },
            "scripts": { "start": "node server.js" },
            "dependencies": { "express": "^4.19.2" }
          }
          JSON

          echo "web: node server.js" > deploy/Procfile

          (cd deploy && zip -r ../app.zip .)

          echo "✅ ZIP content preview:"
          unzip -l app.zip | head -n 80

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Upload to S3
        shell: bash
        run: |
          set -e
          VERSION="${GITHUB_SHA}"
          KEY="releases/${VERSION}.zip"
          aws s3 cp app.zip "s3://${{ secrets.DEPLOY_BUCKET }}/${KEY}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "KEY=${KEY}" >> $GITHUB_ENV

      - name: Create Application Version
        shell: bash
        run: |
          set -e
          aws elasticbeanstalk create-application-version \
            --application-name "${{ secrets.EB_APP_NAME }}" \
            --version-label "${VERSION}" \
            --source-bundle S3Bucket="${{ secrets.DEPLOY_BUCKET }}",S3Key="${KEY}"

      # ✅ أهم خطوة: استنى لحد ما النسخة تبقى PROCESSED
      - name: Wait for Application Version to be PROCESSED
        shell: bash
        run: |
          set -e
          for i in $(seq 1 60); do
            STATUS=$(aws elasticbeanstalk describe-application-versions \
              --application-name "${{ secrets.EB_APP_NAME }}" \
              --version-labels "${VERSION}" \
              --query "ApplicationVersions[0].Status" \
              --output text)

            echo "Version status: ${STATUS} (try ${i}/60)"
            if [ "${STATUS}" = "PROCESSED" ]; then
              echo "✅ Version is PROCESSED"
              exit 0
            fi
            sleep 5
          done

          echo "❌ Version did not become PROCESSED in time"
          exit 1

      - name: Update Environment to new version
        shell: bash
        run: |
          set -e
          aws elasticbeanstalk update-environment \
            --environment-name "${{ secrets.EB_ENV_NAME }}" \
            --version-label "${VERSION}"

      - name: Wait until environment updated
        shell: bash
        run: |
          set -e
          aws elasticbeanstalk wait environment-updated \
            --environment-names "${{ secrets.EB_ENV_NAME }}"
          echo "✅ Environment updated"
